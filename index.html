<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®—åŠ›ç½‘ç»œéƒ¨ç½²å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: #fafbfc;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .upload-box {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }

        .upload-box:hover {
            background: #eef2ff;
            transform: translateY(-2px);
        }

        .upload-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background: #5a67d8;
        }

        .resources-section {
            margin-top: 30px;
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .resource-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .resource-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .resource-card.selected {
            border-color: #48bb78;
            background: #f0fff4;
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.2);
        }

        .resource-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .resource-info {
            margin: 10px 0;
        }

        .resource-info strong {
            color: #667eea;
        }

        .action-buttons {
            text-align: center;
            margin-top: 30px;
        }

        .action-btn {
            background: #48bb78;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 0 10px;
            transition: background 0.3s ease;
        }

        .action-btn:hover {
            background: #38a169;
        }

        .action-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .action-btn.stop {
            background: #e53e3e;
        }

        .action-btn.stop:hover {
            background: #c53030;
        }

        /* æœåŠ¡ç±»å‹é€‰æ‹©æ¡†æ ·å¼ */
        .service-select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }

        .service-select:focus {
            outline: none;
            border-color: #5a67d8;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .service-description {
            margin-top: 10px;
            padding: 10px;
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            font-size: 0.9em;
            color: #4a5568;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .service-description.show {
            opacity: 1;
        }

        .info-box {
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .info-box strong {
            color: #2d3748;
        }

        .status-section {
            margin-top: 30px;
        }

        .status-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }

        .status-item.success {
            border-left-color: #48bb78;
            background: #f0fff4;
        }

        .status-item.error {
            border-left-color: #e53e3e;
            background: #fff5f5;
        }

        .deployment-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .file-list, .script-name {
            margin-top: 15px;
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ ç®—åŠ›ç½‘ç»œéƒ¨ç½²å¹³å°</h1>
            <p>ä¸Šä¼ æ‚¨çš„ä»£ç ï¼Œé€‰æ‹©å¯ç”¨èµ„æºï¼Œä¸€é”®éƒ¨ç½²åˆ°ç›®æ ‡æœåŠ¡å™¨</p>
        </div>

        <div class="main-content">
            <!-- ä¸Šä¼ ä»£ç éƒ¨åˆ† -->
            <div class="section">
                <h2>ğŸ“ ä¸Šä¼ ä»£ç æ–‡ä»¶</h2>
                <div class="upload-section">
                    <div class="upload-box">
                        <h3>ä»£ç åŒ…æ–‡ä»¶</h3>
                        <p>é€‰æ‹©åŒ…å«æ‰€æœ‰ä»£ç æ–‡ä»¶çš„ZIPå‹ç¼©åŒ…</p>
                        <input type="file" id="codeFile" accept=".zip">
                        <button type="button" class="upload-btn" onclick="document.getElementById('codeFile').click()">é€‰æ‹©ZIPæ–‡ä»¶</button>
                        <div id="codeFileList" class="file-list"></div>
                    </div>

                    <div class="upload-box">
                        <h3>å¯åŠ¨è„šæœ¬ (start.sh)</h3>
                        <p>é€‰æ‹©ç”¨äºè¿è¡Œä»£ç çš„å¯åŠ¨è„šæœ¬</p>
                        <input type="file" id="startScript" accept=".sh">
                        <button type="button" class="upload-btn" onclick="document.getElementById('startScript').click()">é€‰æ‹©å¯åŠ¨è„šæœ¬</button>
                        <div id="startScriptName" class="script-name"></div>
                    </div>
                </div>
            </div>

            <!-- å¯ç”¨èµ„æºéƒ¨åˆ† -->
            <div class="section resources-section">
                <h2>ğŸ–¥ï¸ é€‰æ‹©å¯ç”¨èµ„æº</h2>
                <div class="resources-grid" id="resourcesGrid">
                    <!-- èµ„æºå¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons">
                <button type="button" class="action-btn" id="deployBtn" onclick="deployCode()" disabled>ğŸ“¤ å‡†å¤‡éƒ¨ç½²</button>
                <button type="button" class="action-btn stop" id="stopBtn" onclick="stopCode()" disabled>â¹ï¸ åœæ­¢è¿è¡Œ</button>
            </div>

            <!-- éƒ¨ç½²ä¿¡æ¯æ˜¾ç¤º -->
            <div class="section status-section" id="deploymentInfo" style="display: none;">
                <h2>ğŸ“Š éƒ¨ç½²çŠ¶æ€</h2>
                <div id="statusMessages"></div>
            </div>

            <div class="deployment-info" id="deployInfo" style="display: none;">
                <h3>éƒ¨ç½²è¯¦æƒ…</h3>
                <div id="deployDetails"></div>
            </div>

            <!-- å®æ—¶ç›‘æ§æ•°æ®éƒ¨åˆ† -->
            <div class="section" id="monitoringSection" style="display: none;">
                <h2>ğŸ“Š å®æ—¶ç›‘æ§æ•°æ®</h2>
                <div class="status-item" id="lastUpdateInfo">ä¸Šæ¬¡æ›´æ–°: ä»æœª</div>
                <div id="metricsContainer">
                    <!-- æŒ‡æ ‡å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedResource = null;
        let uploadedFiles = {
            code: [],
            script: null
        };
        let monitoringInterval = null; // å®šæ—¶å™¨ID

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // é…ç½®C-SMAåœ°å€
            window.SMA_URL = 'http://192.168.67.185:8083';
            
            loadResources();
            setupEventListeners();
            startRealTimeMonitoring(); // å¯åŠ¨å®æ—¶ç›‘æ§
        });

        // å¯åŠ¨å®æ—¶ç›‘æ§
        function startRealTimeMonitoring() {
            // é¦–æ¬¡åŠ è½½æ•°æ®
            fetchRealTimeMetrics();
            // è®¾ç½®å®šæ—¶åˆ·æ–°ï¼ˆæ¯10ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
            monitoringInterval = setInterval(fetchRealTimeMetrics, 10000);
        }

        // è·å–å®æ—¶æŒ‡æ ‡æ•°æ®
        async function fetchRealTimeMetrics() {
            try {
                // ä½¿ç”¨ç›¸å¯¹è·¯å¾„æˆ–ä»é…ç½®è·å–C-SMAåœ°å€
                const smaUrl = window.SMA_URL || 'http://192.168.67.185:8083';
                const response = await fetch(`${smaUrl}/current-metrics`);
                if (!response.ok) throw new Error(`è·å–ç›‘æ§æ•°æ®å¤±è´¥: ${response.status}`);
                
                const data = await response.json();
                if (data.success) {
                    displayMetricsData(data);
                    // æ›´æ–°ä¸Šæ¬¡æ›´æ–°æ—¶é—´ï¼ˆä¿®å¤ï¼šç§»é™¤å¤šä½™è½¬ä¹‰ç¬¦ï¼‰
                    const lastUpdateInfo = document.getElementById('lastUpdateInfo');
                    lastUpdateInfo.innerHTML = `ä¸Šæ¬¡æ›´æ–°: ${data.last_update_time || 'æœªçŸ¥'} | ç›‘æ§ç«™ç‚¹: ${data.monitored_sites || 0} | æœåŠ¡æ€»æ•°: ${data.service_count || 0} | å®ä¾‹æ€»æ•°: ${data.total_instances || 0}`;
                    lastUpdateInfo.className = 'status-item success';
                } else {
                    throw new Error('C-SMAè¿”å›é”™è¯¯çŠ¶æ€');
                }
            } catch (error) {
                console.error('è·å–å®æ—¶æŒ‡æ ‡å¤±è´¥:', error);
                const lastUpdateInfo = document.getElementById('lastUpdateInfo');
                lastUpdateInfo.innerHTML = `è·å–ç›‘æ§æ•°æ®å¤±è´¥: ${error.message}`;
                lastUpdateInfo.className = 'status-item error';
            }
        }

        // æ˜¾ç¤ºæŒ‡æ ‡æ•°æ®
        function displayMetricsData(data) {
            const container = document.getElementById('metricsContainer');
            const monitoringSection = document.getElementById('monitoringSection');
            monitoringSection.style.display = 'block';

            if (!data.aggregated_data || Object.keys(data.aggregated_data).length === 0) {
                container.innerHTML = '<div class="status-item">æš‚æ— æœåŠ¡å®ä¾‹æ•°æ®</div>';
                return;
            }

            let html = '';
            for (const [serviceId, instances] of Object.entries(data.aggregated_data)) {
                if (instances.length > 0) {
                    html += `<div class="resource-card" style="margin-bottom: 15px;">`;
                    html += `<h3>æœåŠ¡: ${serviceId}</h3>`;
                    html += `<div style="margin-top: 10px;">`;
                    
                    instances.forEach(instance => {
                        html += `
                            <div style="border-bottom: 1px solid #eee; padding: 8px 0;">
                                <div class="resource-info">ğŸ“ <strong>å®ä¾‹åœ°å€:</strong> <a href="${instance.csci_id || '#'}" target="_blank">${instance.csci_id || 'æœªçŸ¥'}</a></div>
                                <div class="resource-info">ğŸ“Š <strong>å®ä¾‹æ•°é‡:</strong> ${instance.gas || 0}</div>
                                <div class="resource-info">ğŸ’° <strong>æˆæœ¬:</strong> ${instance.cost || '0å…ƒ'}</div>
                                <div class="resource-info">â±ï¸ <strong>å»¶è¿Ÿ:</strong> ${instance.delay || 0}ms</div>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                }
            }
            container.innerHTML = html;
        }

        // ä»åç«¯APIåŠ è½½å¯ç”¨èµ„æº
        async function loadResources() {
            try {
                const response = await fetch('/api/resources');
                if (!response.ok) throw new Error(`åŠ è½½èµ„æºå¤±è´¥: ${response.status}`);
                
                const resources = await response.json();
                renderResources(resources);
            } catch (error) {
                showMessage(`âŒ åŠ è½½èµ„æºå¤±è´¥: ${error.message}`, 'error');
                // é»˜è®¤èµ„æºåˆ—è¡¨ï¼ˆä¿®å¤ï¼šå»æ‰æœ«å°¾é€—å·ï¼‰
                const defaultResources = [
                    {
                        id: 'site1',
                        name: 'æœåŠ¡å™¨èŠ‚ç‚¹ 1',
                        url: 'http://localhost:8081',
                        price: 0.5,
                        availableStorage: '100GB',
                        latency: '20ms',
                        location: 'åŒ—äº¬',
                        cpu: '8æ ¸ 3.0GHz',
                        memory: '16GB'
                    },
                    {
                        id: 'site2',
                        name: 'æœåŠ¡å™¨èŠ‚ç‚¹ 2',
                        url: 'http://localhost:8085',
                        price: 0.8,
                        availableStorage: '250GB',
                        latency: '35ms',
                        location: 'ä¸Šæµ·',
                        cpu: '12æ ¸ 2.8GHz',
                        memory: '32GB'
                    }
                ];
                renderResources(defaultResources);
            }
        }

        // æ¸²æŸ“èµ„æºå¡ç‰‡ï¼ˆä¿®å¤ï¼šæ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰é”™è¯¯ï¼‰
        function renderResources(resources) {
            const grid = document.getElementById('resourcesGrid');
            grid.innerHTML = '';

            // æ£€æŸ¥ resources æ˜¯å¦ä¸º null æˆ– undefined
            if (!resources || !Array.isArray(resources)) {
                showMessage('âš ï¸ æ— æ³•è·å–èµ„æºä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤èµ„æºåˆ—è¡¨', 'warning');
                // ä½¿ç”¨é»˜è®¤èµ„æºåˆ—è¡¨
                resources = [
                    {
                        id: 'site1',
                        name: 'æœåŠ¡å™¨èŠ‚ç‚¹ 1',
                        url: 'http://localhost:8081',
                        price: 0.5,
                        availableStorage: '100GB',
                        latency: '20ms',
                        location: 'åŒ—äº¬',
                        cpu: '8æ ¸ 3.0GHz',
                        memory: '16GB'
                    },
                    {
                        id: 'site2',
                        name: 'æœåŠ¡å™¨èŠ‚ç‚¹ 2',
                        url: 'http://localhost:8085',
                        price: 0.8,
                        availableStorage: '250GB',
                        latency: '35ms',
                        location: 'ä¸Šæµ·',
                        cpu: '12æ ¸ 2.8GHz',
                        memory: '32GB'
                    },
                ];
            }

            resources.forEach(resource => {
                const card = document.createElement('div');
                card.className = 'resource-card';
                card.innerHTML = `
                    <h3>${resource.name}</h3>
                    <div class="resource-info">ğŸ“ <strong>ä½ç½®:</strong> ${resource.location}</div>
                    <div class="resource-info">ğŸ’° <strong>ä»·æ ¼:</strong> Â¥${resource.price}/å°æ—¶</div>
                    <div class="resource-info">ğŸ’¾ <strong>å¯ç”¨å­˜å‚¨:</strong> ${resource.availableStorage}</div>
                    <div class="resource-info">âš¡ <strong>å»¶è¿Ÿ:</strong> ${resource.latency}</div>
                    <div class="resource-info">ğŸ’» <strong>CPU:</strong> ${resource.cpu}</div>
                    <div class="resource-info">ğŸ§  <strong>å†…å­˜:</strong> ${resource.memory}</div>
                `;
                card.onclick = () => selectResource(resource, card);
                grid.appendChild(card);
            });
        }

        // é€‰æ‹©èµ„æº
        function selectResource(resource, card) {
            document.querySelectorAll('.resource-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedResource = resource;
            showMessage(`å·²é€‰æ‹©èµ„æº: ${resource.name}`, 'success');
            updateDeployButton();
            updateUIForResource(resource); // æ ¹æ®èµ„æºç±»å‹æ›´æ–°UI
        }

        // æ ¹æ®èµ„æºç±»å‹æ›´æ–°UI
        function updateUIForResource(resource) {
            const uploadSection = document.querySelector('.upload-section');
            const actionButtons = document.querySelector('.action-buttons');
            
            if (!resource) return;
            
            if (resource.id === 'site1') {
                // Site1: æ˜¾ç¤ºæœåŠ¡ç±»å‹é€‰æ‹©ï¼Œéšè—æ–‡ä»¶ä¸Šä¼ 
                uploadSection.innerHTML = `
                    <div class="upload-box">
                        <h3>æœåŠ¡ç±»å‹é€‰æ‹©</h3>
                        <p>é€‰æ‹©è¦éƒ¨ç½²çš„æœåŠ¡ç±»å‹</p>
                        <select id="serviceType" class="service-select">
                            <option value="">è¯·é€‰æ‹©æœåŠ¡ç±»å‹</option>
                            <option value="AR100">AR100 - åŸºç¡€æœåŠ¡</option>
                            <option value="AR1760108487856">äº¤é€šæµé‡ç›‘æµ‹</option>
                            <option value="AR1760108501919">äººè„¸è¯†åˆ«</option>
                            <option value="AR1760108514766">è¯­éŸ³è½¬æ–‡å­—</option>
                        </select>
                        <div id="serviceDescription" class="service-description"></div>
                    </div>
                    <div class="upload-box">
                        <h3>éƒ¨ç½²é…ç½®</h3>
                        <p>Site1 æ”¯æŒé¢„è®¾æœåŠ¡ç±»å‹éƒ¨ç½²</p>
                        <div class="info-box">
                            <strong>å¯ç”¨èµ„æº:</strong> ${resource.availableStorage}<br>
                            <strong>å½“å‰çŠ¶æ€:</strong> ${resource.cpu}<br>
                            <strong>å»¶è¿Ÿ:</strong> ${resource.latency}
                        </div>
                    </div>
                `;
                
                // æ·»åŠ æœåŠ¡ç±»å‹é€‰æ‹©äº‹ä»¶ç›‘å¬
                setTimeout(() => {
                    const serviceSelect = document.getElementById('serviceType');
                    if (serviceSelect) {
                        serviceSelect.addEventListener('change', function() {
                            updateServiceDescription(this.value);
                            updateDeployButton();
                        });
                    }
                }, 100);
                
            } else if (resource.id === 'site2') {
                // Site2: æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ ç•Œé¢
                uploadSection.innerHTML = `
                    <div class="upload-box">
                        <h3>ä»£ç åŒ…æ–‡ä»¶</h3>
                        <p>é€‰æ‹©åŒ…å«æ‰€æœ‰ä»£ç æ–‡ä»¶çš„ZIPå‹ç¼©åŒ…</p>
                        <input type="file" id="codeFile" accept=".zip">
                        <button type="button" class="upload-btn" onclick="document.getElementById('codeFile').click()">é€‰æ‹©ZIPæ–‡ä»¶</button>
                        <div id="codeFileList" class="file-list"></div>
                    </div>

                    <div class="upload-box">
                        <h3>å¯åŠ¨è„šæœ¬ (start.sh)</h3>
                        <p>é€‰æ‹©ç”¨äºè¿è¡Œä»£ç çš„å¯åŠ¨è„šæœ¬</p>
                        <input type="file" id="startScript" accept=".sh">
                        <button type="button" class="upload-btn" onclick="document.getElementById('startScript').click()">é€‰æ‹©å¯åŠ¨è„šæœ¬</button>
                        <div id="startScriptName" class="script-name"></div>
                    </div>
                `;
                
                // é‡æ–°è®¾ç½®æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç›‘å¬
                setTimeout(() => {
                    setupFileUploadListeners();
                }, 100);
            }
            
            // é‡ç½®ä¸Šä¼ æ–‡ä»¶çŠ¶æ€
            uploadedFiles = { code: [], script: null };
            updateDeployButton();
        }

        // æ›´æ–°æœåŠ¡æè¿°
        function updateServiceDescription(serviceType) {
            const description = document.getElementById('serviceDescription');
            if (!description) return;
            
            const descriptions = {
                'AR100': 'åŸºç¡€è®¡ç®—æœåŠ¡ï¼Œé€‚ç”¨äºä¸€èˆ¬æ€§è®¡ç®—ä»»åŠ¡',
                'AR1760108487856': 'æ™ºèƒ½äº¤é€šæµé‡ç›‘æµ‹æœåŠ¡ï¼Œå®æ—¶åˆ†æäº¤é€šçŠ¶å†µ',
                'AR1760108501919': 'é«˜ç²¾åº¦äººè„¸è¯†åˆ«æœåŠ¡ï¼Œæ”¯æŒå¤šç›®æ ‡æ£€æµ‹',
                'AR1760108514766': 'å®æ—¶è¯­éŸ³è½¬æ–‡å­—æœåŠ¡ï¼Œæ”¯æŒå¤šç§è¯­è¨€'
            };
            
            description.innerHTML = descriptions[serviceType] || '';
            description.className = 'service-description' + (serviceType ? ' show' : '');
        }

        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç›‘å¬
        function setupFileUploadListeners() {
            const codeFile = document.getElementById('codeFile');
            const startScript = document.getElementById('startScript');
            
            if (codeFile) {
                codeFile.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    uploadedFiles.code = files;
                    
                    if (files.length > 0 && !files[0].name.toLowerCase().endsWith('.zip')) {
                        showMessage('è­¦å‘Š: è¯·ä¸Šä¼ .zipæ ¼å¼çš„å‹ç¼©åŒ…æ–‡ä»¶', 'error');
                    }
                    
                    const fileList = document.getElementById('codeFileList');
                    if (fileList) {
                        fileList.innerHTML = '<strong>å·²é€‰æ‹©çš„æ–‡ä»¶:</strong><br>';
                        files.forEach(file => {
                            fileList.innerHTML += `- ${file.name} (${formatFileSize(file.size)})<br>`;
                        });
                    }
                    
                    updateDeployButton();
                });
            }
            
            if (startScript) {
                startScript.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        uploadedFiles.script = file;
                        
                        if (!file.name.toLowerCase().endsWith('.sh')) {
                            showMessage('è­¦å‘Š: å»ºè®®ä¸Šä¼ .shæ ¼å¼çš„è„šæœ¬æ–‡ä»¶', 'error');
                        }
                        
                        const scriptName = document.getElementById('startScriptName');
                        if (scriptName) {
                            scriptName.innerHTML = `<strong>å·²é€‰æ‹©:</strong> ${file.name} (${formatFileSize(file.size)})`;
                        }
                    } else {
                        uploadedFiles.script = null;
                        const scriptName = document.getElementById('startScriptName');
                        if (scriptName) {
                            scriptName.innerHTML = '';
                        }
                    }
                    
                    updateDeployButton();
                });
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨ï¼ˆä¿®å¤ï¼šæ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰é”™è¯¯ï¼‰
        function setupEventListeners() {
            document.getElementById('codeFile').addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                uploadedFiles.code = files;

                if (files.length > 0 && !files[0].name.toLowerCase().endsWith('.zip')) {
                    showMessage('è­¦å‘Š: è¯·ä¸Šä¼ .zipæ ¼å¼çš„å‹ç¼©åŒ…æ–‡ä»¶', 'error');
                }
                                // æ˜¾ç¤ºå·²é€‰æ‹©çš„æ–‡ä»¶
                const fileList = document.getElementById('codeFileList');
                fileList.innerHTML = '<strong>å·²é€‰æ‹©çš„æ–‡ä»¶:</strong><br>';
                files.forEach(file => {
                    // ä¿®å¤ï¼šç§»é™¤æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰ç¬¦
                    fileList.innerHTML += `- ${file.name} (${formatFileSize(file.size)})<br>`;
                });

                updateDeployButton();
            });

            document.getElementById('startScript').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    uploadedFiles.script = file;

                    if (!file.name.toLowerCase().endsWith('.sh')) {
                        showMessage('è­¦å‘Š: å»ºè®®ä¸Šä¼ .shæ ¼å¼çš„è„šæœ¬æ–‡ä»¶', 'error');
                    }

                    // ä¿®å¤ï¼šç§»é™¤æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰ç¬¦
                    document.getElementById('startScriptName').innerHTML =
                        `<strong>å·²é€‰æ‹©:</strong> ${file.name} (${formatFileSize(file.size)})`;
                } else {
                    uploadedFiles.script = null;
                    document.getElementById('startScriptName').innerHTML = '';
                }

                updateDeployButton();
            });
        }

        // æ›´æ–°éƒ¨ç½²æŒ‰é’®çŠ¶æ€
        function updateDeployButton() {
            const deployBtn = document.getElementById('deployBtn');
            const stopBtn = document.getElementById('stopBtn');

            let canDeploy = false;
            let buttonText = 'ğŸ“¤ éƒ¨ç½²ä»£ç '; // é»˜è®¤æ–‡æœ¬
            
            if (selectedResource) {
                if (selectedResource.id === 'site1') {
                    // Site1: éœ€è¦é€‰æ‹©æœåŠ¡ç±»å‹
                    const serviceSelect = document.getElementById('serviceType');
                    canDeploy = serviceSelect && serviceSelect.value !== '';
                    buttonText = 'ğŸš€ éƒ¨ç½²æœåŠ¡'; // Site1ä½¿ç”¨æœåŠ¡éƒ¨ç½²
                } else if (selectedResource.id === 'site2') {
                    // Site2: éœ€è¦ä»£ç æ–‡ä»¶å’Œå¯åŠ¨è„šæœ¬
                    canDeploy = uploadedFiles.code.length > 0 && uploadedFiles.script;
                    buttonText = 'ğŸ“¤ éƒ¨ç½²ä»£ç '; // Site2ä½¿ç”¨ä»£ç éƒ¨ç½²
                }
            }

            deployBtn.disabled = !canDeploy;
            deployBtn.textContent = buttonText; // æ›´æ–°æŒ‰é’®æ–‡å­—
            stopBtn.disabled = !selectedResource;

            if (canDeploy) {
                showMessage('âœ… å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥è¿›è¡Œéƒ¨ç½²', 'success');
            }
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆä¿®å¤ï¼šæ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰é”™è¯¯ï¼‰
        function showMessage(message, type = 'info') {
            const infoDiv = document.getElementById('deploymentInfo');
            infoDiv.style.display = 'block';

            const statusDiv = document.getElementById('statusMessages');
            const messageDiv = document.createElement('div');
            // ä¿®å¤ï¼šç§»é™¤æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰ç¬¦
            messageDiv.className = `status-item ${type}`;
            messageDiv.innerHTML = `
                <strong>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'} ${getMessagePrefix(type)}</strong><br>
                ${message}
            `;

            statusDiv.appendChild(messageDiv);
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }

        // è·å–æ¶ˆæ¯å‰ç¼€ï¼ˆä¿®å¤ï¼šå¯¹è±¡è¯­æ³•é—®é¢˜ï¼‰
        function getMessagePrefix(type) {
            switch (type) {
                case 'success':
                    return 'æˆåŠŸ';
                case 'error':
                    return 'é”™è¯¯';
                case 'info':
                    return 'ä¿¡æ¯';
                case 'warning':
                    return 'è­¦å‘Š';
                default:
                    return 'ä¿¡æ¯';
            }
        }

        // éƒ¨ç½²ä»£ç ï¼ˆä¿®å¤ï¼šæ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰é”™è¯¯ï¼‰
        async function deployCode() {
            // æ ¹æ®é€‰æ‹©çš„èµ„æºç±»å‹ï¼Œé‡‡ç”¨ä¸åŒçš„éªŒè¯é€»è¾‘
            if (!selectedResource) {
                showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèµ„æº', 'error');
                return;
            }

            // æ ¹æ®ç«™ç‚¹ç±»å‹éªŒè¯è¾“å…¥
            if (selectedResource.id === 'site1') {
                // Site1: éœ€è¦é€‰æ‹©æœåŠ¡ç±»å‹
                const serviceSelect = document.getElementById('serviceType');
                if (!serviceSelect || !serviceSelect.value) {
                    showMessage('è¯·å…ˆé€‰æ‹©æœåŠ¡ç±»å‹', 'error');
                    return;
                }
            } else if (selectedResource.id === 'site2') {
                // Site2: éœ€è¦ä»£ç æ–‡ä»¶å’Œå¯åŠ¨è„šæœ¬
                if (uploadedFiles.code.length === 0 || !uploadedFiles.script) {
                    showMessage('è¯·å…ˆä¸Šä¼ ä»£ç æ–‡ä»¶å’Œå¯åŠ¨è„šæœ¬', 'error');
                    return;
                }
            }

            // ä¿®å¤ï¼šç§»é™¤æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰ç¬¦
            showMessage(`å¼€å§‹éƒ¨ç½²åˆ° ${selectedResource.name}...`, 'info');

            try {
                const formData = new FormData();
                formData.append('site_id', selectedResource.id);

                if (selectedResource.id === 'site2') {
                    // Site2: ä¸Šä¼ ä»£ç æ–‡ä»¶
                    uploadedFiles.code.forEach(file => {
                        formData.append('codeFiles', file);
                    });
                }

                // æ·»åŠ å¯åŠ¨è„šæœ¬ï¼ˆå¯¹site1æ˜¯æœåŠ¡ç±»å‹ï¼Œå¯¹site2æ˜¯è„šæœ¬æ–‡ä»¶ï¼‰
                if (selectedResource.id === 'site1') {
                    // Site1: æœåŠ¡ç±»å‹
                    const serviceSelect = document.getElementById('serviceType');
                    if (serviceSelect) {
                        formData.append('startScript', serviceSelect.value);
                    }
                } else if (selectedResource.id === 'site2' && uploadedFiles.script) {
                    // Site2: è„šæœ¬æ–‡ä»¶
                    formData.append('startScript', uploadedFiles.script);
                }

                const response = await fetch('/api/deploy', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // ä¿®å¤ï¼šç§»é™¤æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰ç¬¦
                    showMessage(`âœ… ä»£ç å·²æˆåŠŸéƒ¨ç½²åˆ° ${result.site?.name || selectedResource.name}!`, 'success');
                    showDeploymentDetails(result);
                    document.getElementById('stopBtn').disabled = false;
                } else {
                    throw new Error(result.error || 'éƒ¨ç½²å¤±è´¥');
                }
            } catch (error) {
                // ä¿®å¤ï¼šç§»é™¤æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰ç¬¦
                showMessage(`âŒ éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºéƒ¨ç½²è¯¦æƒ…
        function showDeploymentDetails(result) {
            const deployInfo = document.getElementById('deployInfo');
            deployInfo.style.display = 'block';

            let filesList = '';
            if (result.files && result.files.length > 0) {
                filesList = result.files.map(f => `- ${f}`).join('<br>');
            }

            const details = document.getElementById('deployDetails');
            const site = result.site || selectedResource;
            details.innerHTML = `
                <div>
                    <div><strong>ç›®æ ‡æœåŠ¡å™¨:</strong> ${site.name}</div>
                    <div><strong>æœåŠ¡å™¨ä½ç½®:</strong> ${site.location}</div>
                    <div><strong>éƒ¨ç½²æ—¶é—´:</strong> ${new Date().toLocaleString()}</div>
                    <div><strong>ä¸Šä¼ æ–‡ä»¶:</strong><br>${filesList || 'æ— '}</div>
                    ${result.startScript ? `<div><strong>å¯åŠ¨è„šæœ¬:</strong> ${result.startScript}</div>` : ''}
                    <div><strong>é¢„è®¡æˆæœ¬:</strong> Â¥${(site.price * 1).toFixed(2)}/å°æ—¶</div>
                    <div><strong>ç½‘ç»œå»¶è¿Ÿ:</strong> ${site.latency}</div>
                </div>
            `;
        }

        // åœæ­¢è¿è¡Œä»£ç ï¼ˆä¿®å¤ï¼šæ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰é”™è¯¯ï¼‰
        async function stopCode() {
            if (!selectedResource) {
                showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèµ„æº', 'error');
                return;
            }

            // ä¿®å¤ï¼šç§»é™¤æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰ç¬¦
            showMessage(`æ­£åœ¨åœæ­¢åœ¨ ${selectedResource.name} ä¸Šè¿è¡Œçš„æœåŠ¡...`, 'info');

            try {
                const response = await fetch('/api/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        site_id: selectedResource.id
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // ä¿®å¤ï¼šç§»é™¤æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰ç¬¦
                    showMessage(`âœ… å·²æˆåŠŸåœæ­¢åœ¨ ${result.site?.name || selectedResource.name} ä¸Šè¿è¡Œçš„æœåŠ¡`, 'success');
                    document.getElementById('stopBtn').disabled = true;
                } else {
                    throw new Error(result.error || 'åœæ­¢å¤±è´¥');
                }
            } catch (error) {
                // ä¿®å¤ï¼šç§»é™¤æ¨¡æ¿å­—ç¬¦ä¸²è½¬ä¹‰ç¬¦
                showMessage(`âŒ åœæ­¢è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', function() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
        });
    </script>
</body>
</html>