<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®—åŠ›ç½‘ç»œéƒ¨ç½²å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: #fafbfc;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .upload-box {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }
        
        .upload-box:hover {
            background: #eef2ff;
            transform: translateY(-2px);
        }
        
        .upload-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .upload-box input[type="file"] {
            display: none;
        }
        
        .upload-btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }
        
        .upload-btn:hover {
            background: #5a67d8;
        }
        
        .resources-section {
            margin-top: 30px;
        }
        
        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .resource-card {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .resource-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .resource-card.selected {
            border-color: #48bb78;
            background: #f0fff4;
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.2);
        }
        
        .resource-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        
        .resource-info {
            margin: 10px 0;
        }
        
        .resource-info strong {
            color: #667eea;
        }
        
        .action-buttons {
            text-align: center;
            margin-top: 30px;
        }
        
        .action-btn {
            background: #48bb78;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            margin: 0 10px;
            transition: background 0.3s ease;
        }
        
        .action-btn:hover {
            background: #38a169;
        }
        
        .action-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        
        .action-btn.stop {
            background: #e53e3e;
        }
        
        .action-btn.stop:hover {
            background: #c53030;
        }
        
        .status-section {
            margin-top: 30px;
        }
        
        .status-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }
        
        .status-item.success {
            border-left-color: #48bb78;
            background: #f0fff4;
        }
        
        .status-item.error {
            border-left-color: #e53e3e;
            background: #fff5f5;
        }
        
        .deployment-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .upload-section {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ ç®—åŠ›ç½‘ç»œéƒ¨ç½²å¹³å°</h1>
            <p>ä¸Šä¼ æ‚¨çš„ä»£ç ï¼Œé€‰æ‹©å¯ç”¨èµ„æºï¼Œä¸€é”®éƒ¨ç½²åˆ°ç›®æ ‡æœåŠ¡å™¨</p>
        </div>
        
        <div class="main-content">
            <!-- ä¸Šä¼ ä»£ç éƒ¨åˆ† -->
            <div class="section">
                <h2>ğŸ“ ä¸Šä¼ ä»£ç æ–‡ä»¶</h2>
                <div class="upload-section">
                    <div class="upload-box">
                        <h3>å®é™…ä»£ç æ–‡ä»¶</h3>
                        <p>é€‰æ‹©åŒ…å«å®é™…ä¸šåŠ¡é€»è¾‘çš„ä»£ç æ–‡ä»¶</p>
                        <input type="file" id="codeFile" multiple>
                        <button class="upload-btn" onclick="document.getElementById('codeFile').click()">é€‰æ‹©ä»£ç æ–‡ä»¶</button>
                        <div id="codeFileList" style="margin-top: 10px; text-align: left;"></div>
                    </div>
                    
                    <div class="upload-box">
                        <h3>å¯åŠ¨è„šæœ¬ (start.sh)</h3>
                        <p>é€‰æ‹©ç”¨äºè¿è¡Œä»£ç çš„å¯åŠ¨è„šæœ¬</p>
                        <input type="file" id="startScript" accept=".sh">
                        <button class="upload-btn" onclick="document.getElementById('startScript').click()">é€‰æ‹©å¯åŠ¨è„šæœ¬</button>
                        <div id="startScriptName" style="margin-top: 10px; text-align: left;"></div>
                    </div>
                </div>
            </div>
            
            <!-- å¯ç”¨èµ„æºéƒ¨åˆ† -->
            <div class="section resources-section">
                <h2>ğŸ–¥ï¸ é€‰æ‹©å¯ç”¨èµ„æº</h2>
                <div class="resources-grid" id="resourcesGrid">
                    <!-- èµ„æºå¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons">
                <button class="action-btn" id="deployBtn" onclick="deployCode()" disabled>ğŸ“¤ éƒ¨ç½²ä»£ç </button>
                <button class="action-btn stop" id="stopBtn" onclick="stopCode()" disabled>â¹ï¸ åœæ­¢è¿è¡Œ</button>
            </div>
            
            <!-- éƒ¨ç½²ä¿¡æ¯æ˜¾ç¤º -->
            <div class="section status-section" id="deploymentInfo" style="display: none;">
                <h2>ğŸ“Š éƒ¨ç½²çŠ¶æ€</h2>
                <div id="statusMessages"></div>
            </div>
            
            <div class="deployment-info" id="deployInfo" style="display: none;">
                <h3>éƒ¨ç½²è¯¦æƒ…</h3>
                <div id="deployDetails"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedResource = null;
        let uploadedFiles = {
            code: [],
            script: null
        };

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            loadResources();
            setupEventListeners();
        });

        // ä»åç«¯APIåŠ è½½å¯ç”¨èµ„æº
        async function loadResources() {
            try {
                const response = await fetch('/api/resources');
                if (!response.ok) {
                    throw new Error(`åŠ è½½èµ„æºå¤±è´¥: ${response.status}`);
                }
                const resources = await response.json();
                
                renderResources(resources);
            } catch (error) {
                showMessage(`âŒ åŠ è½½èµ„æºå¤±è´¥: ${error.message}`, 'error');
                
                // ä½¿ç”¨é»˜è®¤èµ„æºåˆ—è¡¨ä½œä¸ºå¤‡é€‰
                const defaultResources = [
                    {
                        id: 'site1',
                        name: 'æœåŠ¡å™¨èŠ‚ç‚¹ 1',
                        price: 0.5,
                        availableStorage: '100GB',
                        latency: '20ms',
                        location: 'åŒ—äº¬',
                        cpu: '8æ ¸ 3.0GHz',
                        memory: '16GB'
                    },
                    {
                        id: 'site2',
                        name: 'æœåŠ¡å™¨èŠ‚ç‚¹ 2',
                        price: 0.8,
                        availableStorage: '250GB',
                        latency: '35ms',
                        location: 'ä¸Šæµ·',
                        cpu: '12æ ¸ 2.8GHz',
                        memory: '32GB'
                    },
                    {
                        id: 'site3',
                        name: 'æœåŠ¡å™¨èŠ‚ç‚¹ 3',
                        price: 1.2,
                        availableStorage: '500GB',
                        latency: '15ms',
                        location: 'æ·±åœ³',
                        cpu: '16æ ¸ 3.2GHz',
                        memory: '64GB'
                    }
                ];
                renderResources(defaultResources);
            }
        }

        // æ¸²æŸ“èµ„æºå¡ç‰‡
        function renderResources(resources) {
            const grid = document.getElementById('resourcesGrid');
            grid.innerHTML = '';
            
            resources.forEach(resource => {
                const card = document.createElement('div');
                card.className = 'resource-card';
                card.innerHTML = `
                    <h3>${resource.name}</h3>
                    <div class="resource-info">ğŸ“ <strong>ä½ç½®:</strong> ${resource.location}</div>
                    <div class="resource-info">ğŸ’° <strong>ä»·æ ¼:</strong> Â¥${resource.price}/å°æ—¶</div>
                    <div class="resource-info">ğŸ’¾ <strong>å¯ç”¨å­˜å‚¨:</strong> ${resource.availableStorage}</div>
                    <div class="resource-info">âš¡ <strong>å»¶è¿Ÿ:</strong> ${resource.latency}</div>
                    <div class="resource-info">ğŸ’» <strong>CPU:</strong> ${resource.cpu}</div>
                    <div class="resource-info">ğŸ§  <strong>å†…å­˜:</strong> ${resource.memory}</div>
                `;
                card.onclick = () => selectResource(resource, card);
                grid.appendChild(card);
            });
        }

        // é€‰æ‹©èµ„æº
        function selectResource(resource, card) {
            // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.resource-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            // é€‰æ‹©å½“å‰èµ„æº
            card.classList.add('selected');
            selectedResource = resource;
            
            showMessage(`å·²é€‰æ‹©èµ„æº: ${resource.name}`, 'success');
            updateDeployButton();
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            document.getElementById('codeFile').addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                uploadedFiles.code = files;
                
                // æ˜¾ç¤ºå·²é€‰æ‹©çš„æ–‡ä»¶
                const fileList = document.getElementById('codeFileList');
                fileList.innerHTML = '<strong>å·²é€‰æ‹©çš„æ–‡ä»¶:</strong><br>';
                files.forEach(file => {
                    fileList.innerHTML += `- ${file.name} (${formatFileSize(file.size)})<br>`;
                });
                
                updateDeployButton();
            });
            
            document.getElementById('startScript').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    uploadedFiles.script = file;
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯shellè„šæœ¬
                    if (!file.name.toLowerCase().endsWith('.sh')) {
                        showMessage('è­¦å‘Š: å»ºè®®ä¸Šä¼ .shæ ¼å¼çš„è„šæœ¬æ–‡ä»¶', 'error');
                    }
                    
                    document.getElementById('startScriptName').innerHTML = 
                        `<strong>å·²é€‰æ‹©:</strong> ${file.name} (${formatFileSize(file.size)})`;
                } else {
                    uploadedFiles.script = null;
                    document.getElementById('startScriptName').innerHTML = '';
                }
                
                updateDeployButton();
            });
        }

        // æ›´æ–°éƒ¨ç½²æŒ‰é’®çŠ¶æ€
        function updateDeployButton() {
            const deployBtn = document.getElementById('deployBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            // åªæœ‰åœ¨é€‰æ‹©äº†èµ„æºã€ä¸Šä¼ äº†ä»£ç æ–‡ä»¶å’Œå¯åŠ¨è„šæœ¬åæ‰å¯ç”¨éƒ¨ç½²æŒ‰é’®
            const canDeploy = selectedResource && 
                            uploadedFiles.code.length > 0 && 
                            uploadedFiles.script;
            
            deployBtn.disabled = !canDeploy;
            stopBtn.disabled = !selectedResource; // åªè¦æœ‰é€‰æ‹©çš„èµ„æºå°±å¯ä»¥åœæ­¢
            
            if (canDeploy) {
                showMessage('âœ… å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥è¿›è¡Œéƒ¨ç½²', 'success');
            }
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const infoDiv = document.getElementById('deploymentInfo');
            infoDiv.style.display = 'block';
            
            const statusDiv = document.getElementById('statusMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `status-item ${type}`;
            messageDiv.innerHTML = `
                <strong>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'} ${getMessagePrefix(type)}</strong><br>
                ${message}
            `;
            
            statusDiv.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }
        
        function getMessagePrefix(type) {
            const prefixes = {
                'success': 'æˆåŠŸ',
                'error': 'é”™è¯¯',
                'info': 'ä¿¡æ¯',
                'warning': 'è­¦å‘Š'
            };
            return prefixes[type] || 'ä¿¡æ¯';
        }

        // éƒ¨ç½²ä»£ç 
        async function deployCode() {
            if (!selectedResource || uploadedFiles.code.length === 0 || !uploadedFiles.script) {
                showMessage('è¯·å…ˆé€‰æ‹©èµ„æºå¹¶ä¸Šä¼ ä»£ç æ–‡ä»¶å’Œå¯åŠ¨è„šæœ¬', 'error');
                return;
            }

            showMessage(`å¼€å§‹éƒ¨ç½²ä»£ç åˆ° ${selectedResource.name}...`, 'info');
            
            try {
                // åˆ›å»ºFormDataå¯¹è±¡æ¥ä¸Šä¼ æ–‡ä»¶
                const formData = new FormData();
                
                // æ·»åŠ ç«™ç‚¹ID
                formData.append('site_id', selectedResource.id);
                
                // æ·»åŠ ä»£ç æ–‡ä»¶
                uploadedFiles.code.forEach(file => {
                    formData.append('codeFiles', file);
                });
                
                // æ·»åŠ å¯åŠ¨è„šæœ¬
                if (uploadedFiles.script) {
                    formData.append('startScript', uploadedFiles.script);
                }
                
                // å‘é€éƒ¨ç½²è¯·æ±‚
                const response = await fetch('/api/deploy', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`âœ… ä»£ç å·²æˆåŠŸéƒ¨ç½²åˆ° ${result.site.name}!`, 'success');
                    
                    // æ˜¾ç¤ºéƒ¨ç½²è¯¦æƒ…
                    showDeploymentDetails(result);
                    
                    // å¯ç”¨åœæ­¢æŒ‰é’®
                    document.getElementById('stopBtn').disabled = false;
                } else {
                    throw new Error(result.error || 'éƒ¨ç½²å¤±è´¥');
                }
            } catch (error) {
                showMessage(`âŒ éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºéƒ¨ç½²è¯¦æƒ…
        function showDeploymentDetails(result) {
            const deployInfo = document.getElementById('deployInfo');
            deployInfo.style.display = 'block';
            
            let filesList = '';
            if (result.files && result.files.length > 0) {
                filesList = result.files.map(f => `- ${f}`).join('<br>');
            }
            
            const details = document.getElementById('deployDetails');
            details.innerHTML = `
                <div><strong>ç›®æ ‡æœåŠ¡å™¨:</strong> ${result.site.name}</div>
                <div><strong>æœåŠ¡å™¨ä½ç½®:</strong> ${result.site.location}</div>
                <div><strong>éƒ¨ç½²æ—¶é—´:</strong> ${new Date().toLocaleString()}</div>
                <div><strong>ä¸Šä¼ æ–‡ä»¶:</strong><br>${filesList || 'æ— '}</div>
                ${result.startScript ? `<div><strong>å¯åŠ¨è„šæœ¬:</strong> ${result.startScript}</div>` : ''}
                <div><strong>é¢„è®¡æˆæœ¬:</strong> Â¥${(result.site.price * 1).toFixed(2)}/å°æ—¶</div>
                <div><strong>ç½‘ç»œå»¶è¿Ÿ:</strong> ${result.site.latency}</div>
            `;
        }

        // åœæ­¢è¿è¡Œä»£ç 
        async function stopCode() {
            if (!selectedResource) {
                showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèµ„æº', 'error');
                return;
            }

            showMessage(`æ­£åœ¨åœæ­¢åœ¨ ${selectedResource.name} ä¸Šè¿è¡Œçš„æœåŠ¡...`, 'info');
            
            try {
                const response = await fetch('/api/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        site_id: selectedResource.id
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`âœ… å·²æˆåŠŸåœæ­¢åœ¨ ${selectedResource.name} ä¸Šè¿è¡Œçš„æœåŠ¡`, 'success');
                    
                    // ç¦ç”¨åœæ­¢æŒ‰é’®
                    document.getElementById('stopBtn').disabled = true;
                } else {
                    throw new Error(result.error || 'åœæ­¢å¤±è´¥');
                }
            } catch (error) {
                showMessage(`âŒ åœæ­¢è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>