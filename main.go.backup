package main

import (
        "database/sql"
        "fmt"
        "net/http"
        "time"

        "github.com/gin-gonic/gin"
        _ "github.com/mattn/go-sqlite3" // SQLiteé©±åŠ¨
        "cmas-cats-go/models"
)

// å…¨å±€æ•°æ®åº“è¿æ¥
var db *sql.DB

// æœåŠ¡ç«™ç‚¹é…ç½®
const (
        ListenPort = ":8082"                  // æœåŠ¡ç«™ç‚¹ç›‘å¬ç«¯å£
        DBFile     = "./site.db"              // æ•°æ®åº“æ–‡ä»¶è·¯å¾„
        SiteID     = "site-1"                 // ç«™ç‚¹å”¯ä¸€æ ‡è¯†ï¼ˆå¯ä¿®æ”¹ä¸ºä¸åŒå€¼éƒ¨ç½²å¤šç«™ç‚¹ï¼‰
)

func main() {
        // å¯åŠ¨æ ‡è¯†æ—¥å¿—
        fmt.Println("=====================================")
        fmt.Println("          æœåŠ¡ç«™ç‚¹å¯åŠ¨ä¸­...          ")
        fmt.Println("=====================================")

        // 1. åˆå§‹åŒ–æ•°æ®åº“
        if err := initDB(); err != nil {
                fmt.Printf("âŒ åˆå§‹åŒ–å¤±è´¥ï¼Œç¨‹åºé€€å‡ºï¼š%v\n", err)
                return
        }
        defer db.Close()

        // 2. åˆå§‹åŒ–Ginå¼•æ“
        r := gin.Default()

        // 3. æ³¨å†ŒAPIæ¥å£
        r.POST("/deploy", deployServiceHandler)       // éƒ¨ç½²æœåŠ¡å®ä¾‹
        r.GET("/metrics", getMetricsHandler)          // æš´éœ²å®ä¾‹metricsï¼ˆä¾›C-SMAæ‹‰å–ï¼‰
        r.GET("/health", healthCheckHandler)          // å¥åº·æ£€æŸ¥æ¥å£

        // 4. å¯åŠ¨æœåŠ¡
        fmt.Printf("\nâœ… æœåŠ¡ç«™ç‚¹å¯åŠ¨æˆåŠŸï¼\n")
        fmt.Printf("ğŸ“Œ ç«™ç‚¹IDï¼š%s\n", SiteID)
        fmt.Printf("ğŸ“Œ ç›‘å¬åœ°å€ï¼šhttp://localhost%s\n", ListenPort)
        fmt.Printf("ğŸ“Œ å¯ç”¨æ¥å£ï¼š\n")
        fmt.Printf("   - POST   /deploy        éƒ¨ç½²æœåŠ¡å®ä¾‹\n")
        fmt.Printf("   - GET    /metrics       æŸ¥çœ‹å®ä¾‹metrics\n")
        fmt.Printf("   - GET    /health        å¥åº·æ£€æŸ¥\n")

        // å¯åŠ¨HTTPæœåŠ¡
        if err := r.Run(ListenPort); err != nil {
                fmt.Printf("âŒ æœåŠ¡å¯åŠ¨å¤±è´¥ï¼š%v\n", err)
        }
}

// initDBï¼šåˆå§‹åŒ–SQLiteæ•°æ®åº“
func initDB() error {
        var err error

        // 1. æ‰“å¼€æ•°æ®åº“
        db, err = sql.Open("sqlite3", DBFile)
        if err != nil {
                return fmt.Errorf("æ•°æ®åº“è¿æ¥å¤±è´¥ï¼š%w", err)
        }

        // 2. éªŒè¯è¿æ¥
        if err := db.Ping(); err != nil {
                return fmt.Errorf("æ•°æ®åº“éªŒè¯å¤±è´¥ï¼š%w", err)
        }

        // 3. åˆ›å»ºéƒ¨ç½²å®ä¾‹è¡¨
        createTableSQL := `
        CREATE TABLE IF NOT EXISTS deployed_services (
                id TEXT PRIMARY KEY,
                service_id TEXT NOT NULL,
                gas INT NOT NULL,
                cost INT NOT NULL,
                csci_id TEXT NOT NULL,
                created_at DATETIME NOT NULL,
                delay INT NOT NULL  -- å»¶è¿ŸæŒ‡æ ‡ï¼ˆmsï¼‰
        );`
        _, err = db.Exec(createTableSQL)
        if err != nil {
                return fmt.Errorf("åˆ›å»ºéƒ¨ç½²è¡¨å¤±è´¥ï¼š%w", err)
        }

        fmt.Println("âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸï¼ˆSQLiteï¼‰")
        return nil
}

// deployServiceHandlerï¼šå¤„ç†æœåŠ¡éƒ¨ç½²è¯·æ±‚
func deployServiceHandler(c *gin.Context) {
	var req struct {
		ServiceID string `json:"service_id" binding:"required"` // ç›®æ ‡æœåŠ¡IDï¼ˆå¿…é¡»ï¼‰
		Gas       int    `json:"gas" binding:"min=1"`           // éƒ¨ç½²å®ä¾‹æ•°é‡ï¼ˆè‡³å°‘1ä¸ªï¼‰
	}

	// 1. è§£æè¯·æ±‚å‚æ•°
	if err := c.ShouldBindJSON(&req); err != nil {
		c.JSON(http.StatusBadRequest, gin.H{
			"success": false,
			"message": "è¯·æ±‚æ ¼å¼é”™è¯¯ï¼š" + err.Error(),
		})
		return
	}

	// 2. éªŒè¯æœåŠ¡ç±»å‹æ˜¯å¦æ”¯æŒï¼ˆé¢„è®¾æœåŠ¡åˆ—è¡¨ï¼Œä¸ä¾èµ–å¹³å°æœåŠ¡ï¼‰
	serviceName, resourcePerInst, err := getPresetServiceInfo(req.ServiceID)
	if err != nil {
		c.JSON(http.StatusBadRequest, gin.H{
			"success": false,
			"message": err.Error(),
		})
		return
	}

	// 3. ç”Ÿæˆå®ä¾‹ä¿¡æ¯
	instanceID := fmt.Sprintf("%s-%s-%d", req.ServiceID, SiteID, time.Now().UnixNano()/1e6)
	csciID := fmt.Sprintf("http://192.168.235.48%s/%s", ListenPort, instanceID)
	cost := req.Gas * 2 // æˆæœ¬è®¡ç®—é€»è¾‘ï¼ˆç¤ºä¾‹ï¼šæ•°é‡Ã—2ï¼‰
	delay := 10 + (req.Gas % 10) // æ¨¡æ‹Ÿå»¶è¿Ÿï¼ˆ10-20msï¼‰
	createdAt := time.Now()

	// 4. è®¡ç®—èµ„æºéœ€æ±‚
	totalResourceNeed := resourcePerInst * req.Gas

	// 5. æ£€æŸ¥èµ„æºæ˜¯å¦å……è¶³
	remainingResource := TotalResource - usedResource
	if totalResourceNeed > remainingResource {
		c.JSON(http.StatusForbidden, gin.H{
			"success": false,
			"message": fmt.Sprintf("èµ„æºä¸è¶³ï¼å½“å‰å·²ç”¨%d/æ€»%då•ä½ï¼Œæœ¬æ¬¡éœ€%då•ä½ï¼Œå‰©ä½™%då•ä½",
				usedResource, TotalResource, totalResourceNeed, remainingResource),
			"resource_status": map[string]int{
				"used":      usedResource,
				"total":     TotalResource,
				"remaining": remainingResource,
				"need":      totalResourceNeed,
			},
		})
		return
	}

	// 6. å ç”¨èµ„æºï¼ˆåŠ å†™é”ï¼šæ›´æ–°å·²ç”¨èµ„æºï¼‰
	usedResource += totalResourceNeed

	// 7. å­˜å…¥æ•°æ®åº“
	_, err = db.Exec(`
		INSERT INTO deployed_services (
			id, service_id, gas, cost, csci_id, created_at, delay, resource_per_inst, total_resource_used
		) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,
		instanceID, req.ServiceID, req.Gas, cost, csciID, createdAt, delay, resourcePerInst, totalResourceNeed)

	if err != nil {
		// æ•°æ®åº“æ’å…¥å¤±è´¥ï¼Œå›æ»šèµ„æºå ç”¨
		usedResource -= totalResourceNeed
		c.JSON(http.StatusInternalServerError, gin.H{
			"success": false,
			"message": "éƒ¨ç½²å¤±è´¥ï¼ˆæ•°æ®åº“é”™è¯¯ï¼‰ï¼š" + err.Error(),
		})
		return
	}

	// 8. è¿”å›æˆåŠŸå“åº”
	c.JSON(http.StatusOK, gin.H{
		"success": true,
		"message": fmt.Sprintf("æœåŠ¡å®ä¾‹éƒ¨ç½²æˆåŠŸï¼š%sï¼ˆ%sï¼Œ%dä¸ªå®ä¾‹ï¼‰", req.ServiceID, serviceName, req.Gas),
		"info": map[string]interface{}{
			"service_id": req.ServiceID,
			"gas":        req.Gas,
			"cost":       cost,
			"csci_id":    csciID,
			"delay":      delay,
		},
		"resource_detail": map[string]int{
			"single_inst_resource": resourcePerInst,
			"total_resource_used":  totalResourceNeed,
			"current_used":         usedResource,
			"remaining_resource":   TotalResource - usedResource,
		},
	})
	fmt.Printf("[%s] éƒ¨ç½²æˆåŠŸï¼šID=%s, æœåŠ¡=%s, å®ä¾‹æ•°=%d, æˆæœ¬=%dï¼ˆå ç”¨èµ„æº%då•ä½ï¼‰\n",
		time.Now().Format("15:04:05"), instanceID, serviceName, req.Gas, cost, totalResourceNeed)
}

if err != nil {
                c.JSON(http.StatusInternalServerError, gin.H{
                        "success": false,
                        "message": "éƒ¨ç½²å¤±è´¥ï¼ˆæ•°æ®åº“é”™è¯¯ï¼‰ï¼š" + err.Error(),
                })
                return
        }

        // 4. è¿”å›æˆåŠŸå“åº”
        c.JSON(http.StatusOK, gin.H{
                "success": true,
                "message": fmt.Sprintf("æœåŠ¡å®ä¾‹éƒ¨ç½²æˆåŠŸï¼š%sï¼ˆ%dä¸ªï¼‰", req.ServiceID, req.Gas),
                "info": models.ServiceInstanceInfo{
                        ServiceID: req.ServiceID,
                        Gas:       req.Gas,
                        Cost:      cost,
                        CSCI_ID:   csciID,
                        Delay:     delay,
                },
        })
        fmt.Printf("[%s] éƒ¨ç½²æˆåŠŸï¼šID=%s, æœåŠ¡=%s, å®ä¾‹æ•°=%d\n",
                time.Now().Format("15:04:05"), instanceID, req.ServiceID, req.Gas)
}

// getMetricsHandlerï¼šæš´éœ²å®ä¾‹metricsï¼ˆä¾›C-SMAæ‹‰å–ï¼‰
func getMetricsHandler(c *gin.Context) {
        // 1. æŸ¥è¯¢æ‰€æœ‰éƒ¨ç½²çš„å®ä¾‹
        rows, err := db.Query(`
                SELECT service_id, gas, cost, csci_id, delay
                FROM deployed_services
                ORDER BY created_at DESC`)
        if err != nil {
                c.JSON(http.StatusInternalServerError, gin.H{
                        "success": false,
                        "message": "æŸ¥è¯¢metricså¤±è´¥ï¼š" + err.Error(),
                })
                return
        }
        defer rows.Close()

        // 2. è§£æç»“æœ
        var metrics []models.ServiceInstanceInfo
        for rows.Next() {
                var m models.ServiceInstanceInfo
                if err := rows.Scan(
                        &m.ServiceID, &m.Gas, &m.Cost, &m.CSCI_ID, &m.Delay,
                ); err != nil {
                        fmt.Printf("âš ï¸ è§£æmetricså¤±è´¥ï¼š%v\n", err)
                        continue
                }
                metrics = append(metrics, m)
        }

        // 3. è¿”å›metricsæ•°æ®ï¼ˆä¾›C-SMAèšåˆï¼‰
        c.JSON(http.StatusOK, gin.H{
                "success": true,
                "site_id": SiteID,
                "count":   len(metrics),
                "metrics": metrics,
                "time":    time.Now().Format(time.RFC3339),
        })
}
func healthCheckHandler(c *gin.Context) {
        // ç®€å•æ£€æŸ¥æ•°æ®åº“è¿æ¥
        if err := db.Ping(); err != nil {
                c.JSON(http.StatusInternalServerError, gin.H{
                        "success": false,
                        "status":  "unhealthy",
                        "reason":  "æ•°æ®åº“è¿æ¥å¤±è´¥",
                })
                return
        }

        c.JSON(http.StatusOK, gin.H{
                "success": true,
                "status":  "healthy",
                "site_id": SiteID,
                "time":    time.Now().Format(time.RFC3339),
        })
}




// getPresetServiceInfo è·å–é¢„è®¾æœåŠ¡çš„ä¿¡æ¯ï¼ˆä¸ä¾èµ–å¹³å°æœåŠ¡ï¼‰
func getPresetServiceInfo(serviceID string) (serviceName string, resourcePerInst int, err error) {
	// é¢„è®¾æœåŠ¡åˆ—è¡¨ - æ¨¡æ‹Ÿå¹³å°æ³¨å†Œçš„æœåŠ¡
	presetServices := map[string]struct {
		name              string
		resourcePerInst   int
		description       string
	}{
		"AR100": {
			name:            "åŸºç¡€è®¡ç®—æœåŠ¡",
			resourcePerInst: 50,  // æ¯ä¸ªå®ä¾‹50å•ä½èµ„æº
			description:     "åŸºç¡€è®¡ç®—æœåŠ¡ï¼Œé€‚ç”¨äºä¸€èˆ¬æ€§è®¡ç®—ä»»åŠ¡",
		},
		"AR1760108487856": {
			name:            "äº¤é€šæµé‡ç›‘æµ‹",
			resourcePerInst: 15,  // æ¯ä¸ªå®ä¾‹15å•ä½èµ„æº
			description:     "æ™ºèƒ½äº¤é€šæµé‡ç›‘æµ‹æœåŠ¡",
		},
		"AR1760108501919": {
			name:            "äººè„¸è¯†åˆ«",
			resourcePerInst: 50,  // æ¯ä¸ªå®ä¾‹50å•ä½èµ„æº
			description:     "é«˜ç²¾åº¦äººè„¸è¯†åˆ«æœåŠ¡",
		},
		"AR1760108514766": {
			name:            "è¯­éŸ³è½¬æ–‡å­—",
			resourcePerInst: 30,  // æ¯ä¸ªå®ä¾‹30å•ä½èµ„æº
			description:     "å®æ—¶è¯­éŸ³è½¬æ–‡å­—æœåŠ¡",
		},
	}

	// æŸ¥æ‰¾é¢„è®¾æœåŠ¡
	if service, exists := presetServices[serviceID]; exists {
		return service.name, service.resourcePerInst, nil
	}

	// æœªçŸ¥æœåŠ¡ç±»å‹ï¼Œè¿”å›é”™è¯¯
	return "", 0, fmt.Errorf("ä¸æ”¯æŒçš„æœåŠ¡ç±»å‹: %sï¼ˆè¯·ä½¿ç”¨é¢„è®¾æœåŠ¡IDï¼šAR100, AR1760108487856, AR1760108501919, AR1760108514766ï¼‰", serviceID)
}
